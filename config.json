{
    "Logger": {
        "Formatter": "json",
        "Level": "info"
    },
    "HTTP": {
        "Addr": "127.0.0.1:8080",
        "Handlers": [
           {
                "Method": "get",
                "Path": "/api/v1/tickers",
                "Type": "latest",
                "Latest": {
                    "Format": "json",
                    "Memoize": {
                        "Consumer": {
                            "Format": "json",
                            "Queue": {
                                "Type": "nsq",
                                "Nsq": {
                                    "Addr": "127.0.0.1:4150",
                                    "Channel": "platypus-latest",
                                    "ConsumerBufferSize": 128,
                                    "Topic": "ticker",
                                    "LogLevel": "info"
                                }
                            }
                        },
                        "Cache": {
                            "Store": {
                                "Type": "memoryttl",
                                "MemoryTTL": {
                                    "TTL":        "24h",
				    "Resolution": "1m"
				}
                            },
                            "Key": "{{.market}}|{{(index .currencyPair 0).symbol}}|{{(index .currencyPair 1).symbol}}"
                        }
                    }
                }
            },
            {
                "Method": "get",
                "Path": "/api/v1/tickers-changes",
                "Type": "latests",

                "Latests": {
                    "Format": "json",
                    "Memoize": [
                        {
                            "Consumer": {
                                "Format": "json",
                                "Queue": {
                                    "Type": "nsq",
                                    "Nsq": {
                                        "Addr": "127.0.0.1:4150",
                                        "Topic": "ticker",
                                        "Channel": "platypus-tc-latests",
                                        "ConsumerBufferSize": 128
                                    }
                                }
                            },
                            "Cache": {
                                "Store": {
                                    "Type": "memoryttl",
                                    "MemoryTTL": {
                                        "TTL":        "24h",
					"Resolution": "1m"
				    }
				},
                                "Key": "{{.market}}|{{(index .currencyPair 0).symbol}}|{{(index .currencyPair 1).symbol}}"
                            }
                        },
                        {
                            "Consumer": {
                            "Format": "json",
                            "Queue": {
                                "Type": "nsq",
                                "Nsq": {
                                    "Addr": "127.0.0.1:4150",
                                    "Topic": "change",
                                    "Channel": "platypus-tc-latests",
                                    "ConsumerBufferSize": 128
                                }
                            }
                            },
                            "Cache": {
                                "Store": {
                                    "Type": "memoryttl",
                                    "MemoryTTL": {
                                        "TTL":        "24h",
					"Resolution": "1m"
				    }
                                },
                                "Key": "{{.period}}|{{(index .currencyPair 0).symbol}}|{{(index .currencyPair 1).symbol}}"
                            }
                        }
                    ],
                    "Wrap": "{{\"{\"}}{{range $i, $e := $}}{{if $i}},{{end}}\"{{- $e.Consumer.Queue.Nsq.Topic -}}\":{{- (printf \"%s\" $e.Events.JSON) -}}{{end}}{{\"}\"}}"
                }
            },

            {
                "Method": "get",
                "Path": "/api/v1/tickers/stream",
                "Type": "stream",
                "Stream": {
                    "Format": "json",
                    "Router": {
                        "Type": "broadcast",
                        "Broadcast": {
                            "WriteTimeout": "10s",
                            "Pool": {
                                "Workers": 128,
                                "QueueSize": 1024
                            }
                        }
                    },
                    "Consumer": {
                        "Queue": {
                            "Nsq": {
                                "Addr": "127.0.0.1:4150",
                                "Channel": "platypus-stream",
                                "ConsumerBufferSize": 128,
                                "Topic": "ticker",
                                "LogLevel": "info"
                            },
                            "Type": "nsq"
                        },
                        "Format": "json"
                    }
                }
            },
            {
                "Method": "get",
                "Path": "/api/v1/tickers-changes/stream",
                "Type": "streams",

                "Streams": {
                    "Format": "json",
                    "Consumers": [
                        {
                            "Format": "json",
                            "Queue": {
                                "Type": "nsq",
                                "Nsq": {
                                    "Addr": "127.0.0.1:4150",
                                    "Topic": "ticker",
                                    "Channel": "platypus-tc-streams",
                                    "ConsumerBufferSize": 128
                                }
                            }
                        },
                        {
                            "Format": "json",
                            "Queue": {
                                "Type": "nsq",
                                "Nsq": {
                                    "Addr": "127.0.0.1:4150",
                                    "Topic": "change",
                                    "Channel": "platypus-tc-streams",
                                    "ConsumerBufferSize": 128
                                }
                            }
                        }
                    ],
                    "Wrap": "{\"type\":\"{{- .Consumer.Queue.Nsq.Topic -}}\",\"payload\":{{- (printf \"%s\" .Event.JSON) -}}}",
                    "Router": {
                        "Type": "broadcast",
                        "Broadcast": {
                            "WriteTimeout": "10s",
                            "Pool": {
                                "Workers": 128,
                                "QueueSize": 1024
                            }
                        }
                    }
                }
            }
        ]
    }
}
